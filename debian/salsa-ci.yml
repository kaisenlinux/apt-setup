---
include:
  - https://salsa.debian.org/installer-team/branch2repo/raw/main/trigger_b2r.yml

coverage:
  stage: test
  image: $SALSA_CI_IMAGES_GENERIC_TESTS
  rules:
    - if: $SALSA_CI_ENABLE_COVERAGE =~ /^(1|yes|true)$/
    - if: $SALSA_CI_DISABLE_ALL_TESTS =~ /^(1|yes|true)$/
      when: never
    - if: $SALSA_CI_DISABLE_COVERAGE !~ /^(1|yes|true)$/
  script:
    - export
    - apt-get -y install kcov shunit2 make busybox fakechroot jq
    - make test
    - make coverage COVERAGE_DIR="${WORKING_DIR:-.}/coverage"
    - |
      sed -i -E 's%(filename=")'"${CI_PROJECT_DIR#/}/"'([^"]*")%\1\2%' ${WORKING_DIR}/coverage/kcov-merged/cobertura.xml
  coverage: '/^"Total Code Coverage: \d+\.\d+ %"$/'
  artifacts:
    when: always
    paths:
      - $WORKING_DIR/coverage
    reports:
      coverage_report:
        coverage_format: cobertura
        path: ${WORKING_DIR}/coverage/kcov-merged/cobertura.xml
  needs:
    - job: build
      artifacts: true
